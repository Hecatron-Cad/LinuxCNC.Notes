{"_path":"/os/optimise/exclusions/startupscript","_dir":"exclusions","_draft":false,"_partial":false,"_locale":"","_empty":false,"title":"Startup Script","description":"I'm not sure if the below makes any difference so may be worth further investigation.\nThis includes IRQ Balance and tuna to move things away from the isolated processors that are to be used by linuxcnc.\nIn this case for a Pi4 CPU's 2 and 3.","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"startup-script"},"children":[{"type":"text","value":"Startup Script"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I'm not sure if the below makes any difference so may be worth further investigation."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\nThis includes IRQ Balance and tuna to move things away from the isolated processors that are to be used by linuxcnc."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\nIn this case for a Pi4 CPU's 2 and 3."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://rigtorp.se/low-latency-guide/","rel":["nofollow"]},"children":[{"type":"text","value":"https://rigtorp.se/low-latency-guide/"}]}]}]},{"type":"element","tag":"h2","props":{"id":"installing-tools"},"children":[{"type":"text","value":"Installing Tools"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"First to install the tools we need"}]},{"type":"element","tag":"code","props":{"code":"apt install tuna irqbalance\n","language":"sh","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-f173c6"},"children":[{"type":"text","value":"apt"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"install"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"tuna"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"irqbalance"}]}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"startup-script-1"},"children":[{"type":"text","value":"Startup Script"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Create a new file "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"/var/lib/dietpi/postboot.d/cpu.opt.sh"}]}]},{"type":"element","tag":"code","props":{"code":"#!/bin/sh\n\n# To isolate cores specified in isolcpus using irqbalance\nirqbalance --foreground --oneshot\n\n# Use tuna move all kernel threads away from cores 2-3\ntuna --cpus=2-3 --isolate\n\n# kernel workqueues needs to be moved away from isolated cores. To move all work queues to core 0 (cpumask 0x1):\nfind /sys/devices/virtual/workqueue -name cpumask  -exec sh -c 'echo 1 > {}' ';'\n","language":"sh","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-4870d1"},"children":[{"type":"text","value":"#!/bin/sh\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-4870d1"},"children":[{"type":"text","value":"# To isolate cores specified in isolcpus using irqbalance\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"class":"ct-f173c6"},"children":[{"type":"text","value":"irqbalance"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"--foreground"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"--oneshot\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"class":"ct-4870d1"},"children":[{"type":"text","value":"# Use tuna move all kernel threads away from cores 2-3\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"class":"ct-f173c6"},"children":[{"type":"text","value":"tuna"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"--cpus=2-3"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"--isolate\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"class":"ct-4870d1"},"children":[{"type":"text","value":"# kernel workqueues needs to be moved away from isolated cores. To move all work queues to core 0 (cpumask 0x1):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"class":"ct-f173c6"},"children":[{"type":"text","value":"find"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"/sys/devices/virtual/workqueue"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"-name"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"cpumask"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":"  "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"-exec"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"sh"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"-c"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"'echo 1 > {}'"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"';'"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Make the file executable"}]},{"type":"element","tag":"code","props":{"code":"chmod +x /var/lib/dietpi/postboot.d/cpu.opt.sh\n","language":"sh","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-f173c6"},"children":[{"type":"text","value":"chmod"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"+x"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"/var/lib/dietpi/postboot.d/cpu.opt.sh"}]}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"reporting-on-status"},"children":[{"type":"text","value":"Reporting on Status"}]},{"type":"element","tag":"h3","props":{"id":"irq-balance"},"children":[{"type":"text","value":"IRQ Balance"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For irqbalance we can check that it's done it's job using the below commands"}]},{"type":"element","tag":"code","props":{"code":"# List CPU affinity for all IRQs\nfind /proc/irq/ -name smp_affinity_list -print -exec cat '{}' ';'\n\n# verify that isolated cores are not receiving interrupts by monitoring /proc/interrupts\nwatch cat /proc/interrupts\n","language":"sh","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-4870d1"},"children":[{"type":"text","value":"# List CPU affinity for all IRQs\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-f173c6"},"children":[{"type":"text","value":"find"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"/proc/irq/"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"-name"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"smp_affinity_list"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"-print"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"-exec"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"cat"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"'{}'"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"';'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"class":"ct-4870d1"},"children":[{"type":"text","value":"# verify that isolated cores are not receiving interrupts by monitoring /proc/interrupts\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-f173c6"},"children":[{"type":"text","value":"watch"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"cat"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"/proc/interrupts"}]}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"tuna"},"children":[{"type":"text","value":"Tuna"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To get some feedback from the tuna setup"}]},{"type":"element","tag":"code","props":{"code":"# Use the tuna command to show CPU affinities for all threads\ntuna -P\n\n# List current workqueue affinities:\nfind /sys/devices/virtual/workqueue -name cpumask -print -exec cat '{}' ';'\n","language":"sh","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-4870d1"},"children":[{"type":"text","value":"# Use the tuna command to show CPU affinities for all threads\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-f173c6"},"children":[{"type":"text","value":"tuna"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"-P\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"class":"ct-4870d1"},"children":[{"type":"text","value":"# List current workqueue affinities:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-f173c6"},"children":[{"type":"text","value":"find"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"/sys/devices/virtual/workqueue"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"-name"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"cpumask"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"-print"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"-exec"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"cat"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"'{}'"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"';'"}]}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"perf"},"children":[{"type":"text","value":"Perf"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can use perf to check the status as well"}]},{"type":"element","tag":"code","props":{"code":"# Install linux perf\napt install linux-perf\n\n# Verify if cores were successfully isolated by checking how many thread context switches are occurring per core\n# The isolated cores should show a very low context switch count.\nperf stat -e 'sched:sched_switch' -a -A --timeout 10000\n","language":"sh","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-4870d1"},"children":[{"type":"text","value":"# Install linux perf\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-f173c6"},"children":[{"type":"text","value":"apt"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"install"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"linux-perf\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"class":"ct-4870d1"},"children":[{"type":"text","value":"# Verify if cores were successfully isolated by checking how many thread context switches are occurring per core\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-4870d1"},"children":[{"type":"text","value":"# The isolated cores should show a very low context switch count.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"class":"ct-f173c6"},"children":[{"type":"text","value":"perf"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"stat"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"-e"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-3bda22"},"children":[{"type":"text","value":"'sched:sched_switch'"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"-a"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"-A"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"--timeout"}]},{"type":"element","tag":"span","props":{"class":"ct-d5272e"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-deae4f"},"children":[{"type":"text","value":"10000"}]}]}]}]}]},{"type":"element","tag":"style","children":[{"type":"text","value":".ct-deae4f{color:#0550AE}\n.ct-4870d1{color:#6E7781}\n.ct-3bda22{color:#0A3069}\n.ct-d5272e{color:#24292F}\n.ct-f173c6{color:#953800}\n.dark .ct-f173c6{color:#FFA657}\n.dark .ct-d5272e{color:#C9D1D9}\n.dark .ct-3bda22{color:#A5D6FF}\n.dark .ct-4870d1{color:#8B949E}\n.dark .ct-deae4f{color:#79C0FF}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"installing-tools","depth":2,"text":"Installing Tools"},{"id":"startup-script-1","depth":2,"text":"Startup Script"},{"id":"reporting-on-status","depth":2,"text":"Reporting on Status","children":[{"id":"irq-balance","depth":3,"text":"IRQ Balance"},{"id":"tuna","depth":3,"text":"Tuna"},{"id":"perf","depth":3,"text":"Perf"}]}]}},"_type":"markdown","_id":"content:1.os:4.optimise:5.exclusions:3.startupscript.md","_source":"content","_file":"1.os/4.optimise/5.exclusions/3.startupscript.md","_extension":"md"}